#!/bin/bash
set -e

MANIFEST="$HOME/.config/rclone/backup-repos.txt"
REMOTE="gdrive:BACKUPS"
DRY_RUN=""
KEEP_VERSIONS=3

log() { echo "[$(date +%H:%M:%S)] $*"; }

_path_from_home() {
    # /home/user/Documents/foo → Documents/foo
    echo "${1#$HOME/}"
}

_prune_versions() {
    local remote_path="$1"

    local versions=$(rclone lsf "$REMOTE/$remote_path" --dirs-only 2>/dev/null | \
        grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}/$" | \
        sort -r)

    local count=0
    while IFS= read -r ver; do
        [[ -z "$ver" ]] && continue
        ((++count))
        if [[ $count -gt $KEEP_VERSIONS ]]; then
            log "Pruning old version: $remote_path/$ver"
            [[ -z "$DRY_RUN" ]] && rclone purge "$REMOTE/$remote_path/$ver"
        fi
    done <<< "$versions"
}

_sync_full() {
    local path="$1" remote_path="$2"
    local version_dir="$REMOTE/$remote_path/$(date +%Y-%m-%d_%H-%M)"

    log "Copying (full): $path → $version_dir"
    rclone copy "$path" "$version_dir" $DRY_RUN --progress

    _prune_versions "$remote_path"
}

_sync_git() {
    local path="$1" remote_path="$2"
    local version_dir="$REMOTE/$remote_path/$(date +%Y-%m-%d_%H-%M)"
    local tmpfile=$(mktemp)

    log "Copying (git): $path → $version_dir"
    (cd "$path" && git ls-files && git ls-files --others --exclude-standard) | sort -u > "$tmpfile"
    rclone copy "$path" "$version_dir" --files-from "$tmpfile" $DRY_RUN --progress
    rm "$tmpfile"

    _prune_versions "$remote_path"
}

# Parse args
[[ "$1" == "--dry-run" ]] && DRY_RUN="--dry-run" && log "DRY RUN MODE"

# Process manifest
while IFS=: read -r path mode; do
    [[ "$path" =~ ^#.*$ || -z "$path" ]] && continue
    path="${path%/}"  # trim trailing slash
    remote_path=$(_path_from_home "$path")

    if [[ ! -d "$path" ]]; then
        log "SKIP: Directory not found: $path"
        continue
    fi

    case "$mode" in
        git)  _sync_git "$path" "$remote_path" ;;
        full) _sync_full "$path" "$remote_path" ;;
        *)    log "ERROR: Unknown mode '$mode' for $path" ;;
    esac
done < "$MANIFEST"

log "Backup complete"
