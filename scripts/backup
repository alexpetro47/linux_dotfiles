#!/bin/bash
set -e

SCRIPT_DIR="$(dirname "$(readlink -f "$0")")"

log() { echo "[backup] $*"; }

_backup_repos() {
    log "=== Repos Backup ==="
    "$SCRIPT_DIR/backup-repos" "$@"
}

_backup_bitwarden() {
    log "=== Bitwarden Backup ==="
    "$SCRIPT_DIR/backup-bitwarden"
}

_show_menu() {
    echo ""
    echo "Backup Menu"
    echo "-----------"
    echo "1. Include Bitwarden (master password required)"
    echo "2. Repos only"
    echo "3. Exit"
    echo ""
    read -p "Choice [1-3]: " choice
    echo ""

    case "$choice" in
        1) _backup_bitwarden && echo && _backup_repos ;;
        2) _backup_repos ;;
        3) exit 0 ;;
        *) echo "Invalid choice"; exit 1 ;;
    esac
}

# Parse args
for arg in "$@"; do
    case "$arg" in
        --dry-run)
            DRY_RUN="--dry-run"
            ;;
        --repos)
            _backup_repos $DRY_RUN
            exit 0
            ;;
        --bitwarden)
            _backup_bitwarden
            exit 0
            ;;
        --all)
            _backup_bitwarden && echo && _backup_repos $DRY_RUN
            exit 0
            ;;
        --help|-h)
            echo "Usage: backup [OPTIONS]"
            echo ""
            echo "Options:"
            echo "  --repos       Backup repos only"
            echo "  --bitwarden   Backup Bitwarden only"
            echo "  --all         Backup both"
            echo "  --dry-run     Preview repo sync without changes"
            echo "  -h, --help    Show this help"
            echo ""
            echo "With no options, shows interactive menu."
            exit 0
            ;;
    esac
done

# No args - show menu
_show_menu
