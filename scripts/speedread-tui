#!/bin/bash
# speedread-tui - RSVP speed reading with fzf file selection
#
# Usage:
#   speedread-tui           # fzf select file in cwd
#   speedread-tui file.md   # open specific file
#   speedread-tui -w 500 file.md  # with custom WPM
#
# Keys: h/l ±5 words, j/↓ slower, k/↑ faster, space pause, q/Esc quit

set -e

WPM=400
FILE=""

# Check dependencies
_check_dep() {
	command -v "$1" >/dev/null 2>&1 || {
		echo "Required: $1 not found" >&2
		exit 1
	}
}
_check_dep speedread-keys
_check_dep fzf

# Parse args
while [[ $# -gt 0 ]]; do
	case "$1" in
	-w | --wpm)
		WPM="$2"
		shift 2
		;;
	-h | --help)
		echo "Usage: speedread-tui [-w WPM] [file]"
		echo ""
		echo "Options:"
		echo "  -w, --wpm WPM   Words per minute (default: 400)"
		echo ""
		echo "Keys:"
		echo "  h         Skip back 5 words"
		echo "  l         Skip forward 5 words"
		echo "  j, [, ↓   Slow down (±10 WPM)"
		echo "  k, ], ↑   Speed up (±10 WPM)"
		echo "  space     Pause/resume"
		echo "  q, Esc    Quit"
		exit 0
		;;
	*)
		FILE="$1"
		shift
		;;
	esac
done

# If no file provided, use fzf to select
if [[ -z "$FILE" ]]; then
	# Use fd if available, else fall back to find (max depth 2)
	if command -v fd >/dev/null 2>&1; then
		FILE=$(fd -e md -e txt -e org --type f --max-depth 2 --no-ignore 2>/dev/null | fzf --preview 'head -50 {}' --preview-window=right:50%) || exit 0
	else
		FILE=$(find . -maxdepth 2 -type f \( -name '*.md' -o -name '*.txt' -o -name '*.org' \) 2>/dev/null | fzf --preview 'head -50 {}' --preview-window=right:50%) || exit 0
	fi
fi

if [[ ! -f "$FILE" ]]; then
	echo "File not found: $FILE" >&2
	exit 1
fi

# Get absolute path
FILE=$(readlink -f "$FILE")

# Run directly (no popup)
speedread-keys "$FILE" "$WPM"
