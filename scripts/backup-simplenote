#!/bin/bash
set -e

BACKUP_DIR="$HOME/.local/share/simplenote-backup"
REMOTE_DIR="gdrive:BACKUPS/SIMPLENOTE"
CREDS_FILE="$HOME/.config/simplenote/credentials"
KEEP_VERSIONS=3

log() { echo "[simplenote] $*"; }
err() { echo "[simplenote] ERROR: $*" >&2; }

_prune_versions() {
    local versions=$(rclone lsf "$REMOTE_DIR" --dirs-only 2>/dev/null | \
        grep -E "^[0-9]{4}-[0-9]{2}-[0-9]{2}_[0-9]{2}-[0-9]{2}/$" | \
        sort -r)

    local count=0
    while IFS= read -r ver; do
        [[ -z "$ver" ]] && continue
        ((++count))
        if [[ $count -gt $KEEP_VERSIONS ]]; then
            log "Pruning old version: $ver"
            rclone purge "$REMOTE_DIR/$ver"
        fi
    done <<< "$versions"
}

mkdir -p "$BACKUP_DIR"

# Check credentials
if [ ! -f "$CREDS_FILE" ]; then
    err "Credentials not found at $CREDS_FILE"
    err "Create file with two lines: email and password"
    err "  mkdir -p ~/.config/simplenote"
    err "  echo 'your@email.com' > $CREDS_FILE"
    err "  echo 'your-password' >> $CREDS_FILE"
    err "  chmod 600 $CREDS_FILE"
    exit 1
fi

EMAIL=$(sed -n '1p' "$CREDS_FILE")
PASSWORD=$(sed -n '2p' "$CREDS_FILE")

if [ -z "$EMAIL" ] || [ -z "$PASSWORD" ]; then
    err "Invalid credentials file format"
    exit 1
fi

# Export notes using inline Python (uv handles dependencies)
log "Fetching notes from Simplenote..."
uv run --with simplenote python3 << EOF
import os
import re
from simplenote import Simplenote

email = "$EMAIL"
password = "$PASSWORD"
backup_dir = "$BACKUP_DIR"

sn = Simplenote(email, password)
notes, status = sn.get_note_list(data=True)

if status != 0:
    print(f"[simplenote] ERROR: Failed to fetch notes (status {status})")
    exit(1)

# Clear old exports
for f in os.listdir(backup_dir):
    if f.endswith('.md'):
        os.remove(os.path.join(backup_dir, f))

count = 0
for note in notes:
    if note.get('deleted', False):
        continue

    content = note.get('content', '')
    if not content.strip():
        continue

    # Use first line as filename, fallback to key
    first_line = content.split('\n')[0].strip()
    if first_line:
        # Sanitize filename
        filename = re.sub(r'[^\w\s\-]', '', first_line)[:50].strip()
    else:
        filename = note['key'][:20]

    # Handle duplicates
    base = filename
    counter = 1
    filepath = os.path.join(backup_dir, f"{filename}.md")
    while os.path.exists(filepath):
        filename = f"{base}_{counter}"
        filepath = os.path.join(backup_dir, f"{filename}.md")
        counter += 1

    with open(filepath, 'w') as f:
        f.write(content)
    count += 1

print(f"[simplenote] Exported {count} notes to {backup_dir}")
EOF

# Simple snapshot: copy ALL files to dated dir
VERSION_DIR="$REMOTE_DIR/$(date +%Y-%m-%d_%H-%M)"
log "Copying to $VERSION_DIR..."
rclone copy "$BACKUP_DIR" "$VERSION_DIR" --progress

_prune_versions

log "Done. Kept $KEEP_VERSIONS most recent snapshots."
